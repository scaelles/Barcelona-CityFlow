<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
		//Funcio query Instagram
		var arrayJSON;
		var map;
		function queryInsta(){
			if (window.XMLHttpRequest){
				// code for IE7+, Firefox, Chrome, Opera, Safari
				xmlhttp=new XMLHttpRequest();
			}else{// code for IE6, IE5
				xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
			}
			
			xmlhttp.onreadystatechange=function(){
				if (xmlhttp.readyState==4 && xmlhttp.status==200){
					JSONstring=xmlhttp.responseText;
					arrayJSON = JSON.parse(JSONstring);
					posarInfo();
				}
			}
			xmlhttp.open("GET","getInstaData.php",true);
			xmlhttp.send();
		}

		function createPolygon(coords, strokeColorVar, fillColorVar, numLastPosts){
			//strokeColor: '#FF0000'
			//fillColor: '#F00000'
			var polygonCharacteristics = {
					paths: coords,
					strokeColor: strokeColorVar, //AIXO HA DE DEPENDRE DEL district.lastPosts o algo aixi, JA SIGUI COLOR O OPACITAT (DEL FILL)
					strokeOpacity: 0.8,
					strokeWeight: 3,
					fillColor: fillColorVar, 
					fillOpacity: 0.1
			};
			
			return new google.maps.Polygon(polygonCharacteristics);
		}
		
		function posarInfo(){
			//Els camps disponibles estan en comentari.
			for(var i=0; i<arrayJSON.length; i++){
				var district = arrayJSON[i];
				//district.nameDistrict
				//district.boundsDistrict
				//district.centerDistrict
				
				var districtCoords = [];
				for (var myindex in district.boundsDistrict){
					//alert(district.boundsDistrict[myindex]);
					districtCoords[myindex]= new google.maps.LatLng(parseFloat(district.boundsDistrict[myindex][0]), parseFloat(district.boundsDistrict[myindex][1]));
				}
				//alert(districtCoords);
				arrayJSON[i].boundsDistrictFloat=districtCoords;
				arrayJSON[i].centerDistrictFloat=new google.maps.LatLng(parseFloat(districtCoords[0]), parseFloat(districtCoords[1]));
				
				polygDist = createPolygon(districtCoords,'#FF0000','#F00000',0); 
				arrayJSON[i].polygonDistrict=polygDist;
				arrayJSON[i].polygonDistrict.setMap(map);
				
				google.maps.event.addListener(arrayJSON[i].polygonDistrict, 'mouseover', make_callback(arrayJSON[i].nameDistrict));
				//document.getElementById('footer').innerHTML ="<h2>"+arrayJSON[i].nameDistrict+"</h2>";
				//TODO: Dibuixar poligon si estas en nivell de zoom que toca
				//TODO: Fer infoWindow corresponent si estàs al nivell de zoom
				//TODO: Afegir listener si cal
				
				for(var j=0; j<district.neighbs.length; j++){
					var neighb = district.neighbs[j];					
					//neighb.name
					//neighb.bounds
					//neighb.numLastPosts
						
					var neighbCoords = [];
					for (var myindex in neighb.bounds){
						//alert(district.boundsDistrict[myindex]);
						neighbCoords[myindex]= new google.maps.LatLng(parseFloat(neighb.bounds[myindex][0]), parseFloat(neighb.bounds[myindex][1]));
					}
					neighb.boundsNeighbFloat=neighbCoords;
				  
					neighb.polygonNeighb = createPolygon(neighbCoords,'#16EF74','#16EF74',0); 
					neighb.polygonNeighb.setMap(null);
					

					
					//TODO: Dibuixar poligon si estas en nivell de zoom que toca
					//TODO: Fer infoWindow corresponent si estàs al nivell de zoom
					//TODO: Afegir listener

					for(var k=0; k<neighb.posts.length; k++){
						var post = neighb.posts[k];
						//post.tags
						//post.im_link
						//post.lat
						//post.long
						
						//TODO: Afegir post al heat map
					}
					district.neighbs[j]=neighb;
				}		
			}
			google.maps.event.addListener(map, 'zoom_changed', zoomChanged);
		}
		function initialize() {
			var myLatlng = new google.maps.LatLng(41.392918, 2.180317);
			var markerPos = new google.maps.LatLng(41.397555, 2.191187);

			var mapOptions = {
				zoom: 13,
				center: myLatlng
			};

			map = new google.maps.Map(document.getElementById('mapa'),mapOptions);
			queryInsta();
		}
		
		function zoomChanged(){
			if (map.getZoom()>=14){
				//Amagar districtes i mostrar barris
				for(var i=0; i<arrayJSON.length; i++){
					arrayJSON[i].polygonDistrict.setMap(null);
					for(var j=0; j<arrayJSON[i].neighbs.length; j++){
						arrayJSON[i].neighbs[j].polygonNeighb.setMap(map);
						google.maps.event.addListener(arrayJSON[i].neighbs[j].polygonNeighb, 'mouseover', make_callback(arrayJSON[i].neighbs[j].name));

					}
				}
			}else{
				//Amagar barris i mostrar districtes
				for(var i=0; i<arrayJSON.length; i++){
					arrayJSON[i].polygonDistrict.setMap(map);
					for(var j=0; j<arrayJSON[i].neighbs.length; j++){
						arrayJSON[i].neighbs[j].polygonNeighb.setMap(null);
					}
				}
			}
		}
		
		function make_callback(zonaTXT) {
			return function() {
				document.getElementById('Info').innerHTML ="<h2>"+decodeURIComponent(escape(zonaTXT))+"</h2>";
			};
		}

		google.maps.event.addDomListener(window, 'load', initialize);
		google.maps.event.addDomListener(map,'zoom_changed', zoomChanged);
    </script>
  </head>
  <body>
    <div id='mapa'></div>
	<div id="Info"></div>
  </body>
</html>