<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CityFlow by the makines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

	<!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
	<!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
	<!--script src="js/less-1.3.3.min.js"></script-->
	<!--append ‘#!watch’ to the browser URL, then refresh the page. -->
	
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	  <link href="http://fonts.googleapis.com/css?family=Raleway:400,200,500,600,700,800,300" rel="stylesheet" />
  <link href="fonts.css" rel="stylesheet" type="text/css" media="all" />
  <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=true_or_false"> </script>
	<style>
	#mapa
			{
				position: relative;
				overflow: hidden;
				padding: 0px;
				height:600px;
			}
		@media (min-width: 768px) {
  .navbar-collapse {
    height: auto;
    border-top: 0;
    box-shadow: none;
    max-height: none;
    padding-left:0;
    padding-right:0;
  }
  .navbar-collapse.collapse {
    display: block !important;
    width: auto !important;
    padding-bottom: 0;
    overflow: visible !important;
  }
  .navbar-collapse.in {
    overflow-x: visible;
  }

.navbar
{
	max-width:300px;
	margin-right: 0;
	margin-left: 0;
}	

.navbar-nav,
.navbar-nav > li,
.navbar-left,
.navbar-right,
.navbar-header
{float:none !important;}

.navbar-right .dropdown-menu {left:0;right:auto;}
.navbar-collapse .navbar-nav.navbar-right:last-child {
    margin-right: 0;
}
}
</style>

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
  <link rel="shortcut icon" href="img/favicon.png">
  
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/scripts.js"></script>
	<script type="text/javascript">
		//Funcio query Instagram
		var arrayJSON;
		var map;
		var heatmap;
		var statusHeat=false;
		function queryInsta(){
			if (window.XMLHttpRequest){
				// code for IE7+, Firefox, Chrome, Opera, Safari
				xmlhttp=new XMLHttpRequest();
			}else{// code for IE6, IE5
				xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
			}
			
			xmlhttp.onreadystatechange=function(){
				if (xmlhttp.readyState==4 && xmlhttp.status==200){
					JSONstring=xmlhttp.responseText;
					arrayJSON = JSON.parse(JSONstring);
					posarInfo();
				}
			}
			xmlhttp.open("GET","getInstaData.php",true);
			xmlhttp.send();
		}

		function createPolygon(coords, strokeColorVar, fillColorVar, numLastPosts){
			//strokeColor: '#FF0000'
			//fillColor: '#F00000'
			var polygonCharacteristics = {
					paths: coords,
					strokeColor: strokeColorVar, //AIXO HA DE DEPENDRE DEL district.lastPosts o algo aixi, JA SIGUI COLOR O OPACITAT (DEL FILL)
					strokeOpacity: 0.8,
					strokeWeight: 1,
					fillColor: fillColorVar, 
					fillOpacity: 0.05+ numLastPosts/10
			};
			
			return new google.maps.Polygon(polygonCharacteristics);
		}
		
		function posarInfo(){
			//Els camps disponibles estan en comentari.
			var postsDistrict;
			var postsHeatMap=[];
			var fillColor = ["#DC143C", "#C71585", "#FF8C00", "#8A2BE2", "#228B22", "#6495ED", "#F4A460", "#708090", "#FF1493", "#4B0082"];

			for(var i=0; i<arrayJSON.length; i++){
				postsDistrict=0;
				var district = arrayJSON[i];
				//district.boundsDistrict
				//district.centerDistrict
				
				var districtCoords = [];
				for (var myindex in district.boundsDistrict){
					//alert(district.boundsDistrict[myindex]);
					districtCoords[myindex]= new google.maps.LatLng(parseFloat(district.boundsDistrict[myindex][0]), parseFloat(district.boundsDistrict[myindex][1]));
				}
				//alert(districtCoords);
				arrayJSON[i].boundsDistrictFloat=districtCoords;
				arrayJSON[i].centerDistrictFloat=new google.maps.LatLng(parseFloat(districtCoords[0]), parseFloat(districtCoords[1]));
				
				//document.getElementById('footer').innerHTML ="<h2>"+arrayJSON[i].nameDistrict+"</h2>";
				//TODO: Dibuixar poligon si estas en nivell de zoom que toca
				//TODO: Fer infoWindow corresponent si estàs al nivell de zoom
				//TODO: Afegir listener si cal
				
				for(var j=0; j<district.neighbs.length; j++){
					var neighb = district.neighbs[j];					
					//alert(neighb.name)
					//neighb.bounds
					//neighb.numLastPosts
						
					var neighbCoords = [];
					for (var myindex in neighb.bounds){
						//alert(district.boundsDistrict[myindex]);
						neighbCoords[myindex]= new google.maps.LatLng(parseFloat(neighb.bounds[myindex][0]), parseFloat(neighb.bounds[myindex][1]));
					}
					neighb.boundsNeighbFloat=neighbCoords;
				  
					neighb.polygonNeighb = createPolygon(neighbCoords,fillColor[i],fillColor[i],neighb.numLastPosts); 
					neighb.polygonNeighb.setMap(null);
					

					
					//TODO: Dibuixar poligon si estas en nivell de zoom que toca
					//TODO: Fer infoWindow corresponent si estàs al nivell de zoom
					//TODO: Afegir listener

					//alert (neighb.posts.length);
					postsDistrict = postsDistrict + neighb.numLastPosts;
					
					for(var k=0; k<neighb.posts.length; k++){
						var post = neighb.posts[k];
						//alert(parseFloat(post.lat));
						//alert(post.tags)
						//post.im_link
						//post.lat
						//post.long
						
						postsHeatMap.push(new google.maps.LatLng(parseFloat(post.lat), parseFloat(post.long)));
					}
					district.neighbs[j]=neighb;
				}
				
				//alert (postsDistrict); 
				polygDist = createPolygon(districtCoords,fillColor[i],fillColor[i],postsDistrict); 
				arrayJSON[i].polygonDistrict=polygDist;
				arrayJSON[i].polygonDistrict.setMap(map);
				
				var pointArray = new google.maps.MVCArray(postsHeatMap);
				heatmap = new google.maps.visualization.HeatmapLayer({
					data: pointArray
				});
				heatmap.setMap(null);
				
				google.maps.event.addListener(arrayJSON[i].polygonDistrict, 'mouseover', make_callback(arrayJSON[i],0));
				
			}
			google.maps.event.addListener(map, 'zoom_changed', zoomChanged);
		}
		function initialize() {
			var myLatlng = new google.maps.LatLng(41.392918, 2.180317);
			var markerPos = new google.maps.LatLng(41.397555, 2.191187);

			var mapOptions = {
				zoom: 13,
				center: myLatlng
			};

			map = new google.maps.Map(document.getElementById('mapa'),mapOptions);
			queryInsta();
		}
		
		function zoomChanged(){
			if(statusHeat==false){
				if (map.getZoom()>=14){
					//Amagar districtes i mostrar barris
					for(var i=0; i<arrayJSON.length; i++){
						arrayJSON[i].polygonDistrict.setMap(null);
						for(var j=0; j<arrayJSON[i].neighbs.length; j++){
							arrayJSON[i].neighbs[j].polygonNeighb.setMap(map);
							google.maps.event.addListener(arrayJSON[i].neighbs[j].polygonNeighb, 'mouseover', make_callback(arrayJSON[i].neighbs[j],1));

						}
					}
				}else{
					//Amagar barris i mostrar districtes
					for(var i=0; i<arrayJSON.length; i++){
						arrayJSON[i].polygonDistrict.setMap(map);
						for(var j=0; j<arrayJSON[i].neighbs.length; j++){
							arrayJSON[i].neighbs[j].polygonNeighb.setMap(null);
						}
					}
				}
			}
		}
		
		function toggleHeatMap(){
			//Amagar districtes i mostrar barris
			if(statusHeat==false){
				for(var i=0; i<arrayJSON.length; i++){
					arrayJSON[i].polygonDistrict.setMap(null);
					for(var j=0; j<arrayJSON[i].neighbs.length; j++){
						arrayJSON[i].neighbs[j].polygonNeighb.setMap(null);
					}
				}
				heatmap.setMap(map);
				statusHeat=true;
			}else{
				heatmap.setMap(null);
				if (map.getZoom()>=14){
					//Amagar districtes i mostrar barris
					for(var i=0; i<arrayJSON.length; i++){
						arrayJSON[i].polygonDistrict.setMap(null);
						for(var j=0; j<arrayJSON[i].neighbs.length; j++){
							arrayJSON[i].neighbs[j].polygonNeighb.setMap(map);
							google.maps.event.addListener(arrayJSON[i].neighbs[j].polygonNeighb, 'mouseover', make_callback(arrayJSON[i].neighbs[j],1));

						}
					}
				}else{
					//Amagar barris i mostrar districtes
					for(var i=0; i<arrayJSON.length; i++){
						arrayJSON[i].polygonDistrict.setMap(map);
						for(var j=0; j<arrayJSON[i].neighbs.length; j++){
							arrayJSON[i].neighbs[j].polygonNeighb.setMap(null);
						}
					}
				}
				statusHeat=false;
			}
		}
		
		function make_callback(zona, tipus) {
			return function() {
				var codiTXT ="<h2>"+decodeURIComponent(escape(zona.name))+"</h2>";
				//codiTXT=codiTXT+tipus;
				if(tipus==0){
					//District
					for(var j=0; j<zona.neighbs.length; j++){
						//codiTXT=codiTXT+zona.neighbs[j].name;
						for(var k=0; k<zona.neighbs[j].posts.length; k++){
							var post = zona.neighbs[j].posts[k];
							codiTXT=codiTXT+"<img src='"+post.link+"' width=150></img><br>";
						}
					}
					
				}else{
					for(var i=0; i<zona.posts; i++){
						codiTXT=codiTXT+zona.posts[i].link;
						codiTXT=codiTXT+"<img src='"+zona.posts[i].link+"' width=150></img><br>";
					}
				}
				document.getElementById('infoLateral').innerHTML =codiTXT;
			};
		}

		google.maps.event.addDomListener(window, 'load', initialize);
		google.maps.event.addDomListener(map,'zoom_changed', zoomChanged);
	</script>
</head>

<body>
<div class="container">
	<div class="row clearfix">
		<div class="col-md-2 column">
			<nav class="navbar navbar-default" role="navigation">
			  <!-- Brand and toggle get grouped for better mobile display -->
			  <div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
				  <span class="sr-only">Toggle navigation</span>
				  <span class="icon-bar"></span>
				  <span class="icon-bar"></span>
				  <span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">CityFlow loko0</a>
			  </div>

			  <!-- Collect the nav links, forms, and other content for toggling -->
			  <div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">
				  <li class="active"><a href="#">Homepage</a></li>
				  <li><a href="javascript:toggleHeatMap()">Neighbourhoods</a></li>
				  <li><a href="#">Statistics</a></li>
				  <li><a href="#">About</a></li>
				</ul>
			  </div><!-- /.navbar-collapse -->
			</nav>
		</div>
		<div class="col-md-8 column">
			<div id="mapa">
			<!-- <h2>
				Heading
			</h2>
			<p>
				Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna mollis euismod. Donec sed odio dui.
			</p>
			<p>
				<a class="btn" href="#">View details »</a>
			</p>
			<blockquote>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.
				</p> <small>Someone famous <cite>Source Title</cite></small>
			</blockquote> <address> <strong>Twitter, Inc.</strong><br> 795 Folsom Ave, Suite 600<br> San Francisco, CA 94107<br> <abbr title="Phone">P:</abbr> (123) 456-7890</address> -->
			</div>
		</div>
		<div class="col-md-2 column" id="infoLateral">
			<p>
				Lorem ipsum dolor sit amet, <strong>consectetur adipiscing elit</strong>. Aliquam eget sapien sapien. Curabitur in metus urna. In hac habitasse platea dictumst. Phasellus eu sem sapien, sed vestibulum velit. Nam purus nibh, lacinia non faucibus et, pharetra in dolor. Sed iaculis posuere diam ut cursus. <em>Morbi commodo sodales nisi id sodales. Proin consectetur, nisi id commodo imperdiet, metus nunc consequat lectus, id bibendum diam velit et dui.</em> Proin massa magna, vulputate nec bibendum nec, posuere nec lacus. <small>Aliquam mi erat, aliquam vel luctus eu, pharetra quis elit. Nulla euismod ultrices massa, et feugiat ipsum consequat eu.</small>
			</p>
		</div>
	</div>
</div>
</body>
</html>
